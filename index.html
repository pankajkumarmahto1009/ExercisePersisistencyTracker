<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Persistency Tracker</title>
    
    <!-- PWA / Icon Setup (UPDATED WITH YOUR BLOGGER IMAGE LINK) -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoBMwmUtsrDIRDuc6h1GyYpKuI2bN9H2A_QzFSXQBd831PsPx7jcI6cQzG4Hu4VoP6gOVtER_C2_bFkbrMc_luHEWi5X4Uq3ksO8LqXVOR-E_KJLNOLV_OUmOHggCEZ83sMvV9A6PccY_G-18lFP0Q9NgNmNarH9QgSdWq02gOWnRXo2O419pSFb-X-zA/s1024/1000134900.jpg" sizes="192x192">
    <meta name="theme-color" content="#4F46E5">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Load Moment.js for date calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <!-- Firebase SDKs (Using compat versions for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .tracker-card {
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 0.75rem; /* Rounded corners */
        }
        .tracker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar {
            height: 8px;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            line-height: 1;
        }
        .analysis-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        /* Style for the active period button */
        .period-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>

</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Daily Exercise Tracker</h1>
            <p class="text-lg text-gray-500 mt-1">Consistency is Key (Cloud Synced).</p>
        </header>

        <!-- Status Message -->
        <div id="statusMessage" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-3 bg-gray-800 text-white rounded-lg shadow-xl z-50 text-sm opacity-0 transition-opacity duration-300"></div>
        
        <!-- LOADING INDICATOR (Visible by default until state is determined by JS) -->
        <div id="loadingIndicator" class="fixed inset-0 bg-white/75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <span class="ml-4 text-indigo-700 font-semibold">Syncing Data...</span>
        </div>

        <!-- AUTHENTICATION CONTAINER (Hidden by default) -->
        <div id="authContainer" class="max-w-md mx-auto my-16 p-8 bg-white rounded-xl shadow-2xl border border-gray-100 text-center hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome!</h2>
            <p class="text-gray-600 mb-6">Sign in to sync your progress across all devices.</p>
            
            <button id="googleSignInBtn" onclick="appLogic.handleGoogleLogin()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]" disabled>
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12c6.63 0 12-5.37 12-12S18.63 0 12 0zm0 3.6c2.4 0 4.4 1.6 5.16 3.84L12 10.8V7.2H6.84A5.55 5.55 0 006.4 12c0 2.97 2.43 5.4 5.4 5.4s5.4-2.43 5.4-5.4h1.8c0 3.96-3.24 7.2-7.2 7.2S4.8 15.96 4.8 12 8.04 4.8 12 4.8z" fill="#fff"/></svg>
                <span>Sign in with Google</span>
            </button>
        </div>

        <!-- MAIN TRACKER CONTAINER (Hidden until login) -->
        <div id="trackerAppContainer" class="max-w-6xl mx-auto hidden">
            <!-- Today's Date Display -->
            <div class="text-center mb-8 p-3 bg-indigo-50 border-b border-indigo-200 rounded-lg max-w-lg mx-auto flex justify-between items-center">
                <div class="text-left">
                    <p class="text-sm text-indigo-700 font-medium">Logging for: <span id="todayDateDisplay" class="font-mono font-bold"></span></p>
                    <p class="text-xs text-indigo-500 mt-1">User ID: <span id="userIdDisplay" class="font-mono text-xs"></span></p>
                </div>
                <button onclick="appLogic.handleLogout()" class="text-xs text-red-500 hover:text-red-700 py-1 px-3 border border-red-300 rounded transition duration-150">Logout</button>
            </div>

            <!-- Mindset Card (Centerpiece) - Renamed for commitment -->
            <div id="believeCard" class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 max-w-lg mx-auto mb-8 shadow-lg">
                <div class="flex flex-col items-center justify-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-3">Commit 100%</h2>
                    <p id="mindsetFeedback" class="text-gray-600 text-sm mb-4"></p>
                    <button id="mindsetStatusBtn" onclick="appLogic.toggleMindsetStatus()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-3 px-6 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                        Affirm Commitment
                    </button>
                </div>
            </div>

            <!-- Custom Goal Creator - NEW SECTION -->
            <div id="customGoalCreator" class="max-w-xl mx-auto mb-8 p-6 bg-indigo-50 rounded-xl shadow-lg border border-indigo-200">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Add a Custom Goal
                </h2>
                <div class="space-y-4">
                    <input type="text" id="customGoalName" placeholder="e.g., Pullups, Reading" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400">
                    <div class="flex space-x-4">
                        <input type="number" id="customGoalTarget" placeholder="Target Value (e.g., 20 or 30)" min="1" value="30" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400">
                        <select id="customGoalUnit" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400 bg-white">
                            <option value="Reps">Reps</option>
                            <option value="Min">Minutes</option>
                            <option value="Pages">Pages</option>
                            <option value="Units">Units</option>
                        </select>
                    </div>
                    <button onclick="appLogic.addCustomGoal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md">
                        Add New Tracker
                    </button>
                </div>
            </div>

            <!-- Growth Areas Grid - NEW EXERCISE CATEGORIES -->
            <div id="customGoalsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                <!-- Custom Goal Cards will be inserted here by JavaScript -->
            </div>
            
            <div id="fixedGoalsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                <!-- Pushups (Replacing Academic) -->
                <div id="pushupsCard" class="tracker-card bg-white p-6 border-l-4 border-green-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.433 9.498 5 8 5c-4 0-4 4-4 8 0 1.498.433 2.832 1.253 4M12 6.253c1.168-.82 2.502-1.253 4-1.253 4 0 4 4 4 8 0 1.498-.433 2.832-1.253 4"></path></svg>
                        Total Pushups
                    </h3>
                    <label for="pushupsGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="pushupsGoal" onchange="appLogic.updateGoal('pushups', 'pushupsGoal')" value="50" min="1" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-green-400 focus:border-green-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="pushupsInput" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-green-400 focus:border-green-400">
                            <button onclick="appLogic.updateTracker('pushups', 'pushupsInput')" class="w-1/3 bg-green-400 hover:bg-green-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="pushupsProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="pushupsProgressBar" class="progress-bar bg-green-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Crunches (Replacing Daily Workout) -->
                <div id="crunchesCard" class="tracker-card bg-white p-6 border-l-4 border-blue-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 14v5"></path></svg>
                        Total Crunches
                    </h3>
                    <label for="crunchesGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="crunchesGoal" onchange="appLogic.updateGoal('crunches', 'crunchesGoal')" value="75" min="10" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-400 focus:border-blue-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="crunchesInput" placeholder="0" min="0" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-blue-400 focus:border-blue-400">
                            <button onclick="appLogic.updateTracker('crunches', 'crunchesInput')" class="w-1/3 bg-blue-400 hover:bg-blue-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="crunchesProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="crunchesProgressBar" class="progress-bar bg-blue-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Squats (Replacing Personality & Social) -->
                <div id="squatsCard" class="tracker-card bg-white p-6 border-l-4 border-purple-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Total Squats
                    </h3>
                    <label for="squatsGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="squatsGoal" onchange="appLogic.updateGoal('squats', 'squatsGoal')" value="100" min="10" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-purple-400 focus:border-purple-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="squatsInput" placeholder="0" min="0" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-purple-400 focus:border-purple-400">
                            <button onclick="appLogic.updateTracker('squats', 'squatsInput')" class="w-1/3 bg-purple-400 hover:bg-purple-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="squatsProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="squatsProgressBar" class="progress-bar bg-purple-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Taekwondo Stretching (Replacing Placeholder/Future Area) -->
                <div id="taekwondoCard" class="tracker-card bg-white p-6 border-l-4 border-red-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        Taekwondo Stretching
                    </h3>
                    <label for="taekwondoGoal" class="text-sm font-medium text-gray-500">Goal: Minutes</label>
                    <input type="number" id="taekwondoGoal" onchange="appLogic.updateGoal('taekwondo', 'taekwondoGoal')" value="15" min="5" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-red-400 focus:border-red-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="taekwondoInput" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-red-400 focus:border-red-400">
                            <button onclick="appLogic.updateTracker('taekwondo', 'taekwondoInput')" class="w-1/3 bg-red-400 hover:bg-red-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="taekwondoProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="taekwondoProgressBar" class="progress-bar bg-red-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- ANALYSIS SECTION (Charts) --- -->
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 pt-4 border-t border-gray-300">Analysis & Trends</h2>
            
            <!-- Period Selector -->
            <div class="flex justify-center space-x-2 sm:space-x-4 mb-8 flex-wrap">
                <button id="weekBtn" onclick="appLogic.setAnalysisPeriod('week')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150 mb-2">
                    Compare Week
                </button>
                <button id="monthBtn" onclick="appLogic.setAnalysisPeriod('month')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150 mb-2">
                    Compare Month
                </button>
                <button id="yearBtn" onclick="appLogic.setAnalysisPeriod('year')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150 mb-2">
                    Compare Year
                </button>
                <button id="allBtn" onclick="appLogic.setAnalysisPeriod('all')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150 mb-2">
                    Compare All Time
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-10">
                <!-- Comparison Card -->
                <div class="analysis-card border-t-4 border-indigo-500 lg:col-span-1 flex flex-col justify-center items-center text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Growth Rate</h3>
                    
                    <div class="mb-4">
                        <p id="currentPeriodLabel" class="text-xs text-gray-500 mb-1 font-bold"></p>
                        <p class="text-5xl font-extrabold text-indigo-600" id="currentAvgScore">0%</p>
                        <p class="text-sm text-gray-500">Current Avg.</p>
                    </div>
                    
                    <div class="mb-4">
                        <p id="previousPeriodLabel" class="text-xs text-gray-500 mb-1 font-bold"></p>
                        <p class="text-lg text-gray-800 font-medium" id="previousAvgScore">0%</p>
                        <p class="text-sm text-gray-500">Previous Avg.</p>
                    </div>
                    
                    <div class="mt-4 text-xl font-bold" id="scoreDifference">
                        <!-- Difference text rendered by JS -->
                    </div>
                </div>

                <!-- Chart Cards (3/4 of space on large screens) - This will be dynamically populated -->
                <div id="chartGrid" class="lg:col-span-3 grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Charts will be inserted here by JavaScript -->
                </div>
            </div>
            <!-- --- END ANALYSIS SECTION --- -->


            <!-- Reset Button -->
            <div class="text-center mt-12 pb-4">
                <button onclick="appLogic.resetDailyProgress()" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 py-2 px-4 rounded-lg border border-gray-300 hover:border-red-500">
                    Reset Daily Progress (Start a new day)
                </button>
            </div>
        </div>
    </div>
    
    <!-- *** NEW CUSTOM CONFIRMATION MODAL UI *** -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <div class="text-center">
                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Deletion</h3>
                <p id="modalMessage" class="text-sm text-gray-600 mb-6 font-medium">
                    Are you sure you want to permanently erase the **[Goal Name]** goal? This will **delete ALL history** for this goal from the database.
                </p>
                <div class="flex justify-center space-x-4">
                    <button onclick="appLogic.modalActions.cancel()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancel
                    </button>
                    <button onclick="appLogic.modalActions.confirm()" id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        Erase History
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- *** END MODAL UI *** -->

    <script>
        // Global instance variables for Firebase services and tracking state
        let auth = null; 
        let db = null;   

        // --- FIREBASE CONFIGURATION (USING YOUR NEW PROJECT KEYS) ---
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyDqiw7UTiSPEDXDFRwZPBmBBWQ0sYlQLGg",
            authDomain: "exercise-progress-tracker.firebaseapp.com",
            projectId: "exercise-progress-tracker",
            storageBucket: "exercise-progress-tracker.firebasestorage.app",
            messagingSenderId: "1009491659527",
            appId: "1:1009491659527:web:2488324d4c0cf441acd3a2"
        };
        
        // Environment variables required for Canvas functionality
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;

        // App logic object to manage state and functions
        const appLogic = {
            // STATE
            userId: null,
            history: {}, 
            dailyGoalData: {}, 
            charts: {}, 
            activePeriod: 'week',
            customGoals: [], // New array to track custom goal IDs
            modalTargetArea: null, // New state to track which goal to delete

            // CONSTANTS - UPDATED FOR EXERCISE TRACKING
            TRACKER_AREAS: ['pushups', 'crunches', 'squats', 'taekwondo', 'mindset'],
            DEFAULT_GOALS: {
                pushups: { progress: 0, goal: 50, unit: 'Reps', color: 'green' },
                crunches: { progress: 0, goal: 75, unit: 'Reps', color: 'blue' },
                squats: { progress: 0, goal: 100, unit: 'Reps', color: 'purple' },
                taekwondo: { progress: 0, goal: 15, unit: 'Min', color: 'red' }, // Taekwondo Stretching
                mindset: { status: 'Untoggled', is100: false, unit: 'Affirmed' },
            },
            
            // --- UTILITIES & UI HELPERS ---
            showStatusMessage(message, color) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.textContent = message;
                statusMessage.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 ${color} text-white rounded-lg shadow-xl z-50 text-sm opacity-100 transition-opacity duration-300`;
                statusMessage.classList.remove('hidden');

                setTimeout(() => {
                    statusMessage.classList.remove('opacity-100');
                    statusMessage.classList.add('opacity-0');
                    setTimeout(() => statusMessage.classList.add('hidden'), 300);
                }, 3000);
            },

            setLoading(isLoading) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !isLoading);
                document.getElementById('googleSignInBtn').disabled = isLoading;
            },

            getTodayDateKey() {
                return moment().format('YYYY-MM-DD');
            },

            // --- AUTHENTICATION HANDLERS ---
            async handleGoogleLogin() {
                if (!auth) {
                     appLogic.showStatusMessage('Initialization Failed. Please refresh.', 'bg-red-500');
                     return;
                }

                appLogic.setLoading(true);

                const provider = new firebase.auth.GoogleAuthProvider();
                
                provider.setCustomParameters({
                    prompt: 'select_account' 
                });

                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
                        appLogic.showStatusMessage('Pop-up blocked or cancelled. Check browser settings.', 'bg-yellow-600');
                    } else {
                         appLogic.showStatusMessage(`Sign In Failed: ${error.message}`, 'bg-red-500');
                    }
                    appLogic.setLoading(false);
                }
            },

            handleLogout() {
                auth.signOut();
                appLogic.showStatusMessage('Successfully logged out.', 'bg-gray-500');
            },
            
            setUserId: (uid) => {
                appLogic.userId = uid;
                document.getElementById('userIdDisplay').textContent = uid ? uid : 'No User';
                if (uid) {
                    appLogic.setupDataListener();
                }
            },

            // --- FIREBASE DATA SYNC ---
            async setupDataListener() {
                if (!appLogic.userId) return;

                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(appLogic.userId).collection('growthData').doc('history');

                appLogic.setLoading(true);

                try {
                    docRef.onSnapshot(docSnapshot => {
                        const data = docSnapshot.data() || {};
                        
                        appLogic.history = data.history || {};
                        
                        const todayKey = appLogic.getTodayDateKey();
                        let dailyData = appLogic.history[todayKey] || {};

                        // Step 1: Initialize today's data with defaults
                        appLogic.dailyGoalData = Object.assign({}, appLogic.DEFAULT_GOALS, dailyData);
                        
                        // Step 2: Extract any custom goals saved today or previously
                        appLogic.customGoals = []; // Reset the list
                        
                        // Identify all unique areas (fixed + custom) from ALL history to get persistent goals
                        const allGoalsInHistory = new Set();
                        
                        // Check all days in history to find all unique goal keys
                        Object.values(appLogic.history).forEach(dayData => {
                            Object.keys(dayData).forEach(area => {
                                if (!appLogic.TRACKER_AREAS.includes(area) && area !== 'date') {
                                    allGoalsInHistory.add(area);
                                }
                            });
                        });
                        
                        appLogic.customGoals = Array.from(allGoalsInHistory);
                        
                        // Step 3: Ensure current daily data includes the definition of all persistent custom goals
                        appLogic.customGoals.forEach(area => {
                            if (!appLogic.dailyGoalData[area] && dailyData[area]) {
                                // If the goal isn't defined today, but exists in the raw data, use its definition from raw data
                                appLogic.dailyGoalData[area] = dailyData[area];
                            } else if (!appLogic.dailyGoalData[area]) {
                                // If the goal is not in today's data, we must search history for a full definition
                                const lastDefinition = Object.values(appLogic.history)
                                    .reverse()
                                    .find(dayData => dayData[area] && dayData[area].unit);
                                
                                if (lastDefinition) {
                                    appLogic.dailyGoalData[area] = lastDefinition[area];
                                } else {
                                    // Fallback if somehow a customGoal key exists but no definition is found
                                    appLogic.dailyGoalData[area] = { progress: 0, goal: 30, unit: 'Units', color: 'indigo' };
                                }
                            }
                        });


                        appLogic.dailyGoalData.date = todayKey; 

                        appLogic.renderUI();
                        appLogic.setLoading(false);
                    }, error => {
                        appLogic.showStatusMessage(`Database Error: ${error.message}`, 'bg-red-500');
                        appLogic.setLoading(false);
                    });
                } catch (e) {
                    appLogic.showStatusMessage('Failed to set up data listener.', 'bg-red-500');
                    appLogic.setLoading(false);
                }
            },

            async saveHistory() {
                if (!appLogic.userId) {
                    appLogic.showStatusMessage('Authentication required to save progress.', 'bg-red-500');
                    return;
                }

                const todayKey = appLogic.getTodayDateKey();
                
                // Ensure all fixed and custom keys are present before saving
                const dataToSave = {};
                
                // Include fixed goals
                appLogic.TRACKER_AREAS.forEach(area => {
                    if (appLogic.dailyGoalData[area]) {
                         dataToSave[area] = appLogic.dailyGoalData[area];
                    } else if (appLogic.DEFAULT_GOALS[area]) {
                         dataToSave[area] = appLogic.DEFAULT_GOALS[area]; 
                    }
                });
                
                // Include custom goals
                appLogic.customGoals.forEach(area => {
                    // Only save custom goal data if it still exists in dailyGoalData
                    if (appLogic.dailyGoalData[area]) { 
                        dataToSave[area] = appLogic.dailyGoalData[area];
                    }
                });

                // Update the local history object for TODAY's date
                appLogic.history[todayKey] = {
                    ...dataToSave,
                    date: todayKey
                };

                // NOTE: We rely on `removeGoal` to clean up the rest of `appLogic.history` before this is called.
                
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(appLogic.userId).collection('growthData').doc('history');

                try {
                    // *** FIX: Since appLogic.history now holds the cleaned data (post-removal), we use SET to overwrite it completely, guaranteeing deletion. ***
                    await docRef.set({ history: appLogic.history });
                } catch (e) {
                    appLogic.showStatusMessage(`Save failed: ${e.message}`, 'bg-red-500');
                }
            },

            // --- TRACKER LOGIC ---
            updateGoal(area, inputId) { 
                const input = document.getElementById(inputId);
                let goal = parseFloat(input.value);
                if (isNaN(goal) || goal <= 0) {
                    const defaultGoal = appLogic.DEFAULT_GOALS[area] ? appLogic.DEFAULT_GOALS[area].goal : 30; 
                    goal = defaultGoal;
                    input.value = goal;
                }
                appLogic.dailyGoalData[area].goal = goal;
                appLogic.saveHistory();
                appLogic.showStatusMessage(`Goal for ${area} updated to ${goal} ${appLogic.dailyGoalData[area].unit}.`, 'bg-blue-500');
            },

            updateTracker(area, inputId) { 
                const input = document.getElementById(inputId);
                const value = parseFloat(input.value);

                if (isNaN(value) || value <= 0) {
                    appLogic.showStatusMessage('Please enter a valid positive number.', 'bg-red-500');
                    return;
                }
                appLogic.dailyGoalData[area].progress = (appLogic.dailyGoalData[area].progress || 0) + value;
                input.value = ''; 
                appLogic.saveHistory();
                appLogic.showStatusMessage(`Logged ${value} ${appLogic.dailyGoalData[area].unit} for ${area}!`, 'bg-green-500');
            },

            toggleMindsetStatus() { 
                const area = 'mindset';
                appLogic.dailyGoalData[area].is100 = !appLogic.dailyGoalData[area].is100;
                appLogic.saveHistory();
                if (appLogic.dailyGoalData[area].is100) {
                    appLogic.showStatusMessage('Commitment: 100% affirmed!', 'bg-yellow-400');
                } else {
                    appLogic.showStatusMessage('Commitment status reset.', 'bg-gray-500');
                }
            },
            
            resetDailyProgress() { 
                const todayKey = appLogic.getTodayDateKey();
                const currentGoals = appLogic.dailyGoalData;
                const newDailyData = { date: todayKey };
                
                // Reset fixed goals, keeping their goal value
                appLogic.TRACKER_AREAS.forEach(area => {
                    if (area !== 'mindset' && currentGoals[area]) {
                        newDailyData[area] = { progress: 0, goal: currentGoals[area].goal, unit: currentGoals[area].unit, color: currentGoals[area].color };
                    } else if (area === 'mindset') {
                        newDailyData[area] = { status: 'Untoggled', is100: false };
                    }
                });

                // Reset custom goals, keeping their goal value and unit
                appLogic.customGoals.forEach(area => {
                    if (currentGoals[area]) {
                        newDailyData[area] = { progress: 0, goal: currentGoals[area].goal, unit: currentGoals[area].unit, color: currentGoals[area].color };
                    }
                });

                appLogic.dailyGoalData = newDailyData; 
                appLogic.saveHistory();
                appLogic.showStatusMessage('Daily progress reset! New day, new opportunities!', 'bg-blue-600');
            },
            
            // *** MODIFIED to SHOW MODAL instead of direct deletion ***
            removeGoal(area) {
                const modal = document.getElementById('confirmationModal');
                const modalMessage = document.getElementById('modalMessage');
                const goalLabel = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                appLogic.modalTargetArea = area; // Set state
                
                modalMessage.innerHTML = `Are you sure you want to permanently erase the **${goalLabel}** goal? This action is irreversible and will **delete ALL history** for this goal from the database.`;
                
                // Show modal with transition
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('.transform').classList.remove('scale-95');
                    modal.querySelector('.transform').classList.add('scale-100');
                }, 10);
            },
            
            // *** NEW MODAL ACTIONS OBJECT ***
            modalActions: {
                hide() {
                    const modal = document.getElementById('confirmationModal');
                    // Hide modal with transition
                    modal.classList.remove('opacity-100');
                    modal.querySelector('.transform').classList.remove('scale-100');
                    modal.querySelector('.transform').classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    appLogic.modalTargetArea = null; // Clear state
                },

                cancel() {
                    appLogic.modalActions.hide();
                },

                confirm() {
                    const area = appLogic.modalTargetArea;
                    if (!area) return appLogic.modalActions.hide();

                    appLogic.modalActions.hide();
                    
                    // 1. Remove from local customGoals array
                    appLogic.customGoals = appLogic.customGoals.filter(g => g !== area);
                    
                    // 2. Remove from today's data structure
                    if (appLogic.dailyGoalData[area]) {
                        delete appLogic.dailyGoalData[area];
                    }

                    const goalLabel = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    // 3. Remove the key/value from ALL historical records locally
                    Object.keys(appLogic.history).forEach(dateKey => {
                        if (appLogic.history[dateKey] && appLogic.history[dateKey][area]) {
                            delete appLogic.history[dateKey][area];
                        }
                    });

                    // 4. Force a full overwrite save to Firebase (using .set)
                    appLogic.saveHistory(); 
                    
                    // 5. Update UI
                    appLogic.renderUI(); 
                    appLogic.showStatusMessage(`${goalLabel} goal successfully removed! (History erased)`, 'bg-red-600');
                }
            },


            // NEW: Function to dynamically generate a tracker card HTML
            renderCard(area, data, label, cardColor, svgPath) {
                const colorCode = data.color || 'indigo'; // Fallback to indigo
                const removeButton = appLogic.customGoals.includes(area) ? 
                    `<button onclick="appLogic.removeGoal('${area}')" class="text-xs text-red-400 hover:text-red-600 font-medium transition duration-150 mt-2">Remove Goal</button>` : '';

                const cardHtml = `
                    <div id="${area}Card" class="tracker-card bg-white p-6 border-l-4 border-${colorCode}-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2 text-${colorCode}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${svgPath}</svg>
                                ${label}
                            </span>
                             ${removeButton}
                        </h3>
                        <label for="${area}Goal" class="text-sm font-medium text-gray-500">Goal: ${data.unit}</label>
                        <input type="number" id="${area}Goal" onchange="appLogic.updateGoal('${area}', '${area}Goal')" value="${data.goal}" min="1" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-${colorCode}-400 focus:border-${colorCode}-400">
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="${area}Input" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-${colorCode}-400 focus:border-${colorCode}-400">
                                <button onclick="appLogic.updateTracker('${area}', '${area}Input')" class="w-1/3 bg-${colorCode}-400 hover:bg-${colorCode}-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-gray-700 text-sm font-medium">Progress: <span id="${area}ProgressText" class="font-bold">0%</span></p>
                            <div class="w-full bg-gray-200 progress-bar mt-1">
                                <div id="${area}ProgressBar" class="progress-bar bg-${colorCode}-400" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                `;
                return cardHtml;
            },
            
            addCustomGoal() {
                const nameInput = document.getElementById('customGoalName');
                const targetInput = document.getElementById('customGoalTarget');
                const unitInput = document.getElementById('customGoalUnit');

                const name = nameInput.value.trim();
                const target = parseFloat(targetInput.value);
                const unit = unitInput.value;

                if (!name || isNaN(target) || target <= 0) {
                    appLogic.showStatusMessage('Please enter a valid name and positive goal.', 'bg-red-500');
                    return;
                }

                // Create a unique key for the goal (e.g., pullups_reps)
                const areaKey = name.toLowerCase().replace(/[^a-z0-9]/g, '_'); 
                
                if (appLogic.TRACKER_AREAS.includes(areaKey) || appLogic.customGoals.includes(areaKey)) {
                    appLogic.showStatusMessage(`Goal '${name}' already exists.`, 'bg-yellow-600');
                    return;
                }

                const newGoal = {
                    progress: 0,
                    goal: target,
                    unit: unit,
                    color: 'indigo' // Default color for custom goals
                };
                
                // Add to daily data
                appLogic.dailyGoalData[areaKey] = newGoal;
                // Add to custom goals list
                appLogic.customGoals.push(areaKey);

                // Clear inputs
                nameInput.value = '';
                targetInput.value = 30;
                unitInput.value = 'Reps';

                appLogic.saveHistory();
                appLogic.showStatusMessage(`Custom Goal '${name}' added!`, 'bg-indigo-600');
            },


            // --- RENDER UI ---
            renderUI() { 
                document.getElementById('todayDateDisplay').textContent = moment().format('ddd, MMM D, YYYY');
                
                // Clear the custom goals grid and re-render them
                const customGoalsGrid = document.getElementById('customGoalsGrid');
                customGoalsGrid.innerHTML = ''; 

                // Combine fixed and custom goals for rendering
                const allTrackedAreas = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals);

                allTrackedAreas.forEach(area => {
                    // Skip rendering if the goal was just deleted but the state hasn't fully propagated
                    if (!appLogic.dailyGoalData[area] && !appLogic.DEFAULT_GOALS[area]) return; 

                    const data = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area];
                    const goal = data.goal || appLogic.DEFAULT_GOALS[area].goal;
                    const progress = data.progress || 0;
                    
                    // Logic to handle dynamically created cards for custom goals
                    if (appLogic.customGoals.includes(area)) {
                        const areaLabel = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Convert key to Title Case
                        
                        // Use a generic SVG path for custom goals
                        const customSvgPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>';
                        
                        // *** CRITICAL FIX APPLIED HERE: Use insertAdjacentHTML for reliable DOM population ***
                        customGoalsGrid.insertAdjacentHTML('beforeend', appLogic.renderCard(area, data, areaLabel, `border-${data.color}-400`, customSvgPath));
                        
                    } else {
                        // Fixed cards already exist in the HTML, so we just update their values
                        const goalInput = document.getElementById(`${area}Goal`);
                        if(goalInput) goalInput.value = goal;
                    }

                    // *** CORE PROGRESS UPDATE LOGIC (Applies to both fixed and custom) ***
                    // Ensure elements are sought after insertion
                    const progressPercent = Math.min(100, (progress / goal) * 100);
                    const progressBar = document.getElementById(`${area}ProgressBar`);
                    const progressText = document.getElementById(`${area}ProgressText`);
                    const card = document.getElementById(`${area}Card`);
                    const colorCode = data.color || appLogic.DEFAULT_GOALS[area].color;

                    if (progressBar && progressText && card) { // Ensure elements exist for fixed/newly created custom goals
                        progressBar.style.width = `${progressPercent}%`;
                        progressText.textContent = `${progress} / ${goal} (${Math.round(progressPercent)}%)`;

                        // Reset all ring/color classes (need to list all possible colors for Tailwind JIT compilation)
                        card.classList.remove('ring-2', 'ring-offset-2', 'ring-green-400', 'ring-offset-white', 'ring-blue-400', 'ring-purple-400', 'ring-red-400', 'ring-indigo-400');
                        progressBar.classList.remove('!bg-green-600', '!bg-blue-600', '!bg-purple-600', '!bg-red-600', '!bg-indigo-600');

                        if (progressPercent >= 100) {
                            card.classList.add('ring-2', 'ring-offset-2', `ring-${colorCode}-400`, 'ring-offset-white');
                            progressBar.classList.add(`!bg-${colorCode}-600`);
                        }
                    }
                });

                const mindsetBtn = document.getElementById('mindsetStatusBtn');
                const mindsetFeedback = document.getElementById('mindsetFeedback');
                const mindsetData = appLogic.dailyGoalData['mindset'];
                const is100 = mindsetData ? mindsetData.is100 : false;

                if (is100) {
                    mindsetBtn.textContent = 'COMMITMENT Locked';
                    mindsetBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    mindsetBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    mindsetFeedback.innerHTML = '<span class="status-badge bg-green-100 text-green-700">Commitment is Locked In!</span>';
                } else {
                    mindsetBtn.textContent = 'Affirm Commitment';
                    mindsetBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    mindsetBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                    mindsetFeedback.innerHTML = '<span class="status-badge bg-yellow-100 text-yellow-700">Awaiting Affirmation</span>';
                }

                appLogic.setAnalysisPeriod(appLogic.activePeriod);
            },
            
            // --- ANALYSIS & CHARTING ---
            setAnalysisPeriod(period) {
                appLogic.activePeriod = period;
                document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('period-active'));
                const activeBtn = document.getElementById(`${period}Btn`);
                if (activeBtn) { activeBtn.classList.add('period-active'); }
                appLogic.renderAnalysis();
            },

            getAnalysisDuration() { 
                const today = moment().startOf('day');
                let duration, previousDuration;
                switch (appLogic.activePeriod) {
                    case 'week': duration = 7; previousDuration = 7; break;
                    case 'month': duration = 30; previousDuration = 30; break;
                    case 'year': duration = 365; previousDuration = 365; break;
                    case 'all':
                        const historyDates = Object.keys(appLogic.history).sort();
                        if (historyDates.length === 0) { duration = 1; previousDuration = 0; break; }
                        const firstDay = moment(historyDates[0], 'YYYY-MM-DD');
                        const totalDays = today.diff(firstDay, 'days') + 1;
                        duration = Math.ceil(totalDays / 2); previousDuration = Math.floor(totalDays / 2); 
                        break;
                    default: duration = 7; previousDuration = 7;
                }
                return { duration, previousDuration };
            },
            
            // --- MAPPING 0% TO NULL FOR GAPS ---
            getDailyPerformance(duration, endDate, startDate) { 
                const dailyData = {};
                // Exclude mindset for the score and include custom goals
                const areaKeys = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 
                const end = endDate || moment().startOf('day');
                const start = startDate || moment(end).subtract(duration - 1, 'days').startOf('day');
                
                const datesInPeriod = [];
                for (let date = moment(start); date.isSameOrBefore(end); date.add(1, 'days')) {
                    datesInPeriod.push(date.format('YYYY-MM-DD'));
                }

                datesInPeriod.forEach(dateKey => {
                    const data = appLogic.history[dateKey];
                    const result = {};
                    areaKeys.forEach(area => {
                        // Use dailyGoalData for goal value if history is missing it for the day
                        const currentData = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area]; 
                        const areaData = data && data[area] ? data[area] : currentData;
                        const progress = areaData.progress || 0;
                        const goal = areaData.goal || currentData.goal; 
                        const completion = Math.min(100, (progress / goal) * 100);
                        
                        // Map 0% completion to NULL to create a gap in the line chart
                        result[area] = progress > 0 ? completion : null;
                    });
                    dailyData[dateKey] = result;
                });
                return dailyData;
            },
            
            calculateAverages(periodData) { 
                const areaKeys = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 
                const total = areaKeys.reduce((acc, area) => ({ ...acc, [area]: 0 }), {});
                const days = Object.keys(periodData).length;
                
                let validDaysCount = 0;
                
                Object.values(periodData).forEach(day => {
                    let areaCount = 0;
                    areaKeys.forEach(area => {
                         const completionValue = day[area] === null ? 0 : day[area];
                         total[area] += completionValue;
                         areaCount++;
                    });
                    if (areaCount > 0) { validDaysCount++; }
                });
                
                const avg = {};
                areaKeys.forEach(area => {
                    avg[area] = days > 0 ? (total[area] / days) : 0;
                });
                
                const overallAvg = areaKeys.length > 0 ? (Object.values(avg).reduce((sum, val) => sum + val, 0) / areaKeys.length) : 0;
                
                return { avg: avg, overallAvg: overallAvg, days: days };
            },
            
            renderAnalysis() { 
                const { duration, previousDuration } = appLogic.getAnalysisDuration();
                const today = moment().startOf('day');
                let currentPeriodEnd = today;
                let currentPeriodStart = moment(today).subtract(duration - 1, 'days');
                let previousPeriodEnd = moment(currentPeriodStart).subtract(1, 'second');
                let previousPeriodStart = moment(previousPeriodEnd).subtract(previousDuration - 1, 'days');
                const currentDataRaw = appLogic.getDailyPerformance(duration, currentPeriodEnd, currentPeriodStart);
                const previousDataRaw = appLogic.getDailyPerformance(previousDuration, previousPeriodEnd, previousPeriodStart);
                const currentAverages = appLogic.calculateAverages(currentDataRaw);
                const previousAverages = appLogic.calculateAverages(previousDataRaw);
                const currentAvgScore = Math.round(currentAverages.overallAvg);
                const previousAvgScore = Math.round(previousAverages.overallAvg);
                const diff = currentAvgScore - previousAvgScore;

                document.getElementById('currentPeriodLabel').textContent = `${appLogic.activePeriod === 'all' ? 'Second Half' : 'Current Period'} (${currentAverages.days} Days)`;
                document.getElementById('previousPeriodLabel').textContent = `${appLogic.activePeriod === 'all' ? 'First Half' : 'Previous Period'} (${previousAverages.days} Days)`;
                document.getElementById('currentAvgScore').textContent = `${currentAvgScore}%`;
                document.getElementById('previousAvgScore').textContent = `${previousAvgScore}%`;
                
                const diffElement = document.getElementById('scoreDifference');
                diffElement.innerHTML = `${diff > 0 ? '' : diff < 0 ? '' : ''} ${Math.abs(diff)}%`;
                diffElement.classList.toggle('text-green-600', diff >= 0);
                diffElement.classList.toggle('text-red-600', diff < 0);
                
                const labels = Array.from({ length: currentAverages.days }, (_, i) => {
                     // Use 'M/D' for week view, 'D' for month/year (clamped down for better visibility)
                     if (appLogic.activePeriod === 'week' || appLogic.activePeriod === 'all') {
                        return moment(currentPeriodStart).add(i, 'days').format('M/D');
                     } else if (appLogic.activePeriod === 'month') {
                        return moment(currentPeriodStart).add(i, 'days').format('D'); // Day number for monthly view
                     } else {
                        return moment(currentPeriodStart).add(i, 'days').format('MMM'); // Month abbreviation for yearly view
                     }
                });
                
                // Get ALL non-mindset areas (fixed and custom)
                const allChartAreas = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 

                // Clear the chart container for dynamic charts
                const analysisContainer = document.getElementById('chartGrid');
                analysisContainer.innerHTML = ''; 

                allChartAreas.forEach(area => {
                    const currentTrend = labels.map((label, i) => {
                         const dateKey = moment(currentPeriodStart).add(i, 'days').format('YYYY-MM-DD');
                         return currentDataRaw[dateKey] ? currentDataRaw[dateKey][area] : null;
                    });
                    
                    const previousKeys = Object.keys(previousDataRaw).sort();
                    const previousTrend = Array.from({ length: labels.length }, (_, i) => {
                        const prevDateKey = previousKeys[i];
                        return previousDataRaw[prevDateKey] ? previousDataRaw[prevDateKey][area] : null;
                    });
                    
                    // NEW: Dynamically create the canvas element for the chart
                    const chartCard = document.createElement('div');
                    chartCard.classList.add('analysis-card', 'h-64', 'md:h-72');
                    chartCard.innerHTML = `<canvas id="${area}Chart"></canvas>`;
                    analysisContainer.appendChild(chartCard);
                    
                    appLogic.drawChart(area, labels, currentTrend, previousTrend);
                });
            },

            drawChart(area, labels, currentTrend, previousTrend) { 
                if (appLogic.charts[area]) { appLogic.charts[area].destroy(); }
                const ctx = document.getElementById(`${area}Chart`);
                if (!ctx) return;
                const context = ctx.getContext('2d');

                let color, label;
                const data = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area];
                const areaName = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // For custom goal label

                switch (data.color || area) { // Check color first, then area for fixed goals
                    case 'green': color = 'rgba(52, 211, 153, 1)'; label = 'Pushup Progress'; break;
                    case 'blue': color = 'rgba(96, 165, 250, 1)'; label = 'Crunch Progress'; break;
                    case 'purple': color = 'rgba(167, 139, 250, 1)'; label = 'Squat Progress'; break;
                    case 'red': color = 'rgba(248, 113, 113, 1)'; label = 'Taekwondo Stretch'; break;
                    case 'indigo':
                    default: color = 'rgba(79, 70, 229, 1)'; label = `${areaName} Progress`; break; // Default to Indigo for custom
                }

                appLogic.charts[area] = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { 
                                label: 'Current Period', 
                                data: currentTrend, 
                                borderColor: color, 
                                backgroundColor: color.replace('1)', '0.1)'), 
                                fill: false, 
                                tension: 0.2, 
                                pointRadius: 3, 
                                borderWidth: 3,
                                spanGaps: true 
                            },
                            { 
                                label: 'Previous Period', 
                                data: previousTrend, 
                                borderColor: color.replace('1)', '0.5)'), 
                                backgroundColor: 'transparent', 
                                borderDash: [5, 5], 
                                fill: false, 
                                tension: 0.2, 
                                pointRadius: 0, 
                                borderWidth: 2,
                                spanGaps: true 
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: label, color: '#4B5563', padding: { top: 10, bottom: 5 } }
                        },
                        scales: {
                            x: { 
                                grid: { display: false }, 
                                ticks: { 
                                    autoSkip: true, 
                                    maxRotation: 0, 
                                    minRotation: 0,
                                    maxTicksLimit: appLogic.activePeriod === 'week' ? 4 : (appLogic.activePeriod === 'month' ? 6 : 12),
                                    callback: function(value, index, values) {
                                        // Only show the label if it's the first, middle (for week), or last point, or if autoSkip hasn't cut it.
                                        if (appLogic.activePeriod === 'week') {
                                            const total = values.length;
                                            const start = 0;
                                            const middle = Math.floor(total / 2);
                                            const end = total - 1;
                                            if (index === start || index === middle || index === end) {
                                                return value;
                                            }
                                            return null;
                                        }
                                        return value;
                                    }
                                }
                            },
                            y: { 
                                min: 0, 
                                max: 100, 
                                title: { display: true, text: 'Completion (%)' },
                                suggestedMin: 0
                            }
                        }
                    }
                });
            }
        };


        // --- INITIALIZATION ---
        window.onload = async function() {
            firebase.setLogLevel('debug');
            
            try {
                const app = firebase.initializeApp(hardcodedFirebaseConfig);
                auth = app.auth();
                db = app.firestore();
            } catch (e) {
                console.error("FATAL: Firebase Initialization Error:", e);
                appLogic.showStatusMessage('FATAL: Initialization failed.', 'bg-red-900');
                return;
            }

            let authStateHandled = false;
            appLogic.setLoading(true);

            try {
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (e) {
                console.error("Initial Auth Error:", e);
            }
            
            const loadingTimeout = setTimeout(() => {
                if (!authStateHandled) {
                    appLogic.setLoading(false);
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('googleSignInBtn').disabled = false;
                    appLogic.showStatusMessage('Automatic sign-in failed. Please sign in with Google.', 'bg-yellow-600');
                }
            }, 5000);

            auth.onAuthStateChanged((user) => {
                clearTimeout(loadingTimeout);
                authStateHandled = true;

                appLogic.setLoading(false); 
                document.getElementById('googleSignInBtn').disabled = false; 

                if (user) {
                    appLogic.setUserId(user.uid);
                    document.getElementById('authContainer').classList.add('hidden');
                    document.getElementById('trackerAppContainer').classList.remove('hidden');
                    appLogic.showStatusMessage('Successfully loaded dashboard.', 'bg-indigo-600');
                } else {
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('trackerAppContainer').classList.add('hidden');
                }
            });
        };
    </script>

</body>
</html>

