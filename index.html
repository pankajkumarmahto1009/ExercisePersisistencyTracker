<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Persistency Tracker</title>
    
    <!-- PWA / Icon Setup -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoBMwmUtsrDIRDuc6h1GyYpKuI2bN9H2A_QzFSXQBd831PsPx7jcI6cQzG4Hu4VoP6gOVtER_C2_bFkbrMc_luHEWi5X4Uq3ksO8LqXVOR-E_KJLNOLV_OUmOHggCEZ83sMvV9A6PccY_G-18lFP0Q9NgNmNarH9QgSdWq02gOWnRXo2O419pSFb-X-zA/s1024/1000134900.jpg" sizes="192x192">
    <meta name="theme-color" content="#4F46E5">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Load Moment.js for date calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <!-- Pre-load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .tracker-card {
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 0.75rem; /* Rounded corners */
        }
        .tracker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar {
            height: 8px;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            line-height: 1;
        }
        .analysis-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            /* Ensure fixed width for scrolling on mobile grid items */
            min-width: 180px; 
        }
        /* Style for the active period button */
        .period-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* Style for the date picker */
        #monthYearPicker {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px; /* full rounded */
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #4b5563; /* gray-700 */
            background-color: #ffffff;
            cursor: pointer;
            transition: border-color 0.15s ease-in-out;
            outline: none;
        }
        #monthYearPicker:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
    </style>

</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Daily Exercise Tracker</h1>
            <p class="text-lg text-gray-500 mt-1">Consistency is Key (Cloud Synced).</p>
        </header>

        <!-- Status Message -->
        <div id="statusMessage" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-3 bg-gray-800 text-white rounded-lg shadow-xl z-50 text-sm opacity-0 transition-opacity duration-300"></div>
        
        <!-- LOADING INDICATOR (Visible by default until state is determined by JS) -->
        <div id="loadingIndicator" class="fixed inset-0 bg-white/75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <span class="ml-4 text-indigo-700 font-semibold">Syncing Data...</span>
        </div>

        <!-- AUTHENTICATION CONTAINER (Hidden by default) -->
        <div id="authContainer" class="max-w-md mx-auto my-16 p-8 bg-white rounded-xl shadow-2xl border border-gray-100 text-center hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome!</h2>
            <p class="text-gray-600 mb-6">Sign in to sync your progress across all devices. We've automatically signed you in, but you can use Google to ensure full persistence.</p>
            
            <button id="googleSignInBtn" onclick="appLogic.handleGoogleLogin()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]" disabled>
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12c6.63 0 12-5.37 12-12S18.63 0 12 0zm0 3.6c2.4 0 4.4 1.6 5.16 3.84L12 10.8V7.2H6.84A5.55 5.55 0 006.4 12c0 2.97 2.43 5.4 5.4 5.4s5.4-2.43 5.4-5.4h1.8c0 3.96-3.24 7.2-7.2 7.2S4.8 15.96 4.8 12 8.04 4.8 12 4.8z" fill="#fff"/></svg>
                <span>Sign in with Google</span>
            </button>
        </div>

        <!-- MAIN TRACKER CONTAINER (Hidden until login) -->
        <div id="trackerAppContainer" class="max-w-6xl mx-auto hidden">
            <!-- Today's Date Display -->
            <div class="text-center mb-8 p-3 bg-indigo-50 border-b border-indigo-200 rounded-lg max-w-lg mx-auto flex justify-between items-center">
                <div class="text-left">
                    <p class="text-sm text-indigo-700 font-medium">Logging for: <span id="todayDateDisplay" class="font-mono font-bold"></span></p>
                    <p class="text-xs text-indigo-500 mt-1">User ID: <span id="userIdDisplay" class="font-mono text-xs break-all"></span></p>
                </div>
                <button onclick="appLogic.handleLogout()" class="text-xs text-red-500 hover:text-red-700 py-1 px-3 border border-red-300 rounded transition duration-150">Logout</button>
            </div>

            <!-- Mindset Card (Centerpiece) - Renamed for commitment -->
            <div id="believeCard" class="bg-white p-6 rounded-xl border-l-4 border-yellow-400 max-w-lg mx-auto mb-8 shadow-lg">
                <div class="flex flex-col items-center justify-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-3">Commit 100%</h2>
                    <p id="mindsetFeedback" class="text-gray-600 text-sm mb-4"></p>
                    <button id="mindsetStatusBtn" onclick="appLogic.toggleMindsetStatus()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-3 px-6 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                        Affirm Commitment
                    </button>
                </div>
            </div>
            
            <!-- Custom Goal Toggle Button -->
            <div class="max-w-xl mx-auto mb-6">
                <button onclick="appLogic.toggleCustomGoalForm()" id="toggleGoalFormBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-indigo-700 font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-sm flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Add New Custom Goal</span>
                </button>
            </div>


            <!-- Custom Goal Creator - NEW SECTION -->
            <div id="customGoalCreator" class="max-w-xl mx-auto mb-8 p-6 bg-indigo-50 rounded-xl shadow-lg border border-indigo-200 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Define Your New Tracker
                </h2>
                <div class="space-y-4">
                    <input type="text" id="customGoalName" placeholder="e.g., Pullups, Reading" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400">
                    <div class="flex space-x-4">
                        <input type="number" id="customGoalTarget" placeholder="Target Value (e.g., 20 or 30)" min="1" value="30" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400">
                        <select id="customGoalUnit" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-indigo-400 focus:border-indigo-400 bg-white">
                            <option value="Reps">Reps</option>
                            <option value="Min">Minutes</option>
                            <option value="Pages">Pages</option>
                            <option value="Units">Units</option>
                        </select>
                    </div>
                    <button onclick="appLogic.addCustomGoal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md">
                        Add New Tracker
                    </button>
                </div>
            </div>

            <!-- Growth Areas Grid - NEW EXERCISE CATEGORIES -->
            <div id="customGoalsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                <!-- Custom Goal Cards will be inserted here by JavaScript -->
            </div>
            
            <div id="fixedGoalsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                <!-- Pushups (Replacing Academic) -->
                <div id="pushupsCard" class="tracker-card bg-white p-6 border-l-4 border-green-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.433 9.498 5 8 5c-4 0-4 4-4 8 0 1.498.433 2.832 1.253 4M12 6.253c1.168-.82 2.502-1.253 4-1.253 4 0 4 4 4 8 0 1.498-.433 2.832-1.253 4"></path></svg>
                        Total Pushups
                    </h3>
                    <label for="pushupsGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="pushupsGoal" onchange="appLogic.updateGoal('pushups', 'pushupsGoal')" value="50" min="1" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-green-400 focus:border-green-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="pushupsInput" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-green-400 focus:border-green-400">
                            <button onclick="appLogic.updateTracker('pushups', 'pushupsInput')" class="w-1/3 bg-green-400 hover:bg-green-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="pushupsProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="pushupsProgressBar" class="progress-bar bg-green-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Crunches (Replacing Daily Workout) -->
                <div id="crunchesCard" class="tracker-card bg-white p-6 border-l-4 border-blue-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 14v5"></path></svg>
                        Total Crunches
                    </h3>
                    <label for="crunchesGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="crunchesGoal" onchange="appLogic.updateGoal('crunches', 'crunchesGoal')" value="75" min="10" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-400 focus:border-blue-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="crunchesInput" placeholder="0" min="0" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-blue-400 focus:border-blue-400">
                            <button onclick="appLogic.updateTracker('crunches', 'crunchesInput')" class="w-1/3 bg-blue-400 hover:bg-blue-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="crunchesProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="crunchesProgressBar" class="progress-bar bg-blue-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Squats (Replacing Personality & Social) -->
                <div id="squatsCard" class="tracker-card bg-white p-6 border-l-4 border-purple-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Total Squats
                    </h3>
                    <label for="squatsGoal" class="text-sm font-medium text-gray-500">Goal: Reps</label>
                    <input type="number" id="squatsGoal" onchange="appLogic.updateGoal('squats', 'squatsGoal')" value="100" min="10" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-purple-400 focus:border-purple-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="squatsInput" placeholder="0" min="0" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-purple-400 focus:border-purple-400">
                            <button onclick="appLogic.updateTracker('squats', 'squatsInput')" class="w-1/3 bg-purple-400 hover:bg-purple-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="squatsProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="squatsProgressBar" class="progress-bar bg-purple-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Taekwondo Stretching (Replacing Placeholder/Future Area) -->
                <div id="taekwondoCard" class="tracker-card bg-white p-6 border-l-4 border-red-400">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        Taekwondo Stretching
                    </h3>
                    <label for="taekwondoGoal" class="text-sm font-medium text-gray-500">Goal: Minutes</label>
                    <input type="number" id="taekwondoGoal" onchange="appLogic.updateGoal('taekwondo', 'taekwondoGoal')" value="15" min="5" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-red-400 focus:border-red-400">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="taekwondoInput" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-red-400 focus:border-red-400">
                            <button onclick="appLogic.updateTracker('taekwondo', 'taekwondoInput')" class="w-1/3 bg-red-400 hover:bg-red-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-700 text-sm font-medium">Progress: <span id="taekwondoProgressText" class="font-bold">0%</span></p>
                        <div class="w-full bg-gray-200 progress-bar mt-1">
                            <div id="taekwondoProgressBar" class="progress-bar bg-red-400" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- --- ANALYSIS SECTION (Charts) --- -->
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 pt-4 border-t border-gray-300">Analysis & Trends</h2>
            
            <!-- Period Selector -->
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8 flex-wrap">
                <button id="weekBtn" onclick="appLogic.setAnalysisPeriod('week')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150">
                    Compare Week
                </button>
                <button id="monthBtn" onclick="appLogic.setAnalysisPeriod('month')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150">
                    Compare Month
                </button>
                <button id="yearBtn" onclick="appLogic.setAnalysisPeriod('year')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150">
                    Compare Year
                </button>
                <button id="allBtn" onclick="appLogic.setAnalysisPeriod('all')" class="period-btn py-2 px-4 sm:px-6 rounded-full text-sm sm:text-base text-gray-700 border border-gray-300 hover:bg-indigo-100 transition duration-150">
                    Compare All Time
                </button>
            </div>
            
            <!-- Historical Date Picker -->
            <div class="flex justify-center items-center space-x-3 mb-8">
                <input type="month" id="monthYearPicker" value="" class="text-sm">
                <button onclick="appLogic.viewHistoricalReport()" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-full text-sm font-semibold transition duration-150 shadow-md">
                    View Report
                </button>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-10">
                <!-- Comparison Card -->
                <div class="analysis-card border-t-4 border-indigo-500 lg:col-span-1 flex flex-col justify-center items-center text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Growth Rate</h3>
                    
                    <div class="mb-4">
                        <p id="currentPeriodLabel" class="text-xs text-gray-500 mb-1 font-bold"></p>
                        <p class="text-5xl font-extrabold text-indigo-600" id="currentAvgScore">0%</p>
                        <p class="text-sm text-gray-500">Current Avg.</p>
                    </div>
                    
                    <div class="mb-4">
                        <p id="previousPeriodLabel" class="text-xs text-gray-500 mb-1 font-bold"></p>
                        <p class="text-lg text-gray-800 font-medium" id="previousAvgScore">0%</p>
                        <p class="text-sm text-gray-500">Previous Avg.</p>
                    </div>
                    
                    <div class="mt-4 text-xl font-bold" id="scoreDifference">
                        <!-- Difference text rendered by JS -->
                    </div>
                </div>

                <!-- Chart Cards (3/4 of space on large screens) - This will be dynamically populated -->
                <!-- WRAPPER DIV for Horizontal Scrolling on mobile -->
                <div class="lg:col-span-3 overflow-x-auto">
                    <div id="chartGrid" class="flex flex-row space-x-6 pb-2 lg:grid lg:grid-cols-4 lg:gap-6 lg:space-x-0">
                        <!-- Charts will be inserted here by JavaScript -->
                    </div>
                </div>
                
            </div>
            <!-- --- END ANALYSIS SECTION --- -->


            <!-- Reset Button -->
            <div class="text-center mt-12 pb-4">
                <button onclick="appLogic.resetDailyProgress()" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 py-2 px-4 rounded-lg border border-gray-300 hover:border-red-500">
                    Reset Daily Progress (Start a new day)
                </button>
            </div>
        </div>
    </div>
    
    <!-- *** CUSTOM CONFIRMATION MODAL UI *** -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <div class="text-center">
                <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Action</h3>
                <p id="modalMessage" class="text-sm text-gray-600 mb-6 font-medium">
                    Are you sure you want to proceed?
                </p>
                <div class="flex justify-center space-x-4">
                    <button onclick="appLogic.modalActions.cancel()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                        Cancel
                    </button>
                    <button onclick="appLogic.modalActions.confirm()" id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- *** END CUSTOM CONFIRMATION MODAL UI *** -->


    <script type="module">
        // --- FIREBASE MODULAR IMPORTS (V10+) ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // ----------------------------------------
        
        // Global instance variables for Firebase services and tracking state
        let auth = null; 
        let db = null;   

        // --- FIREBASE CONFIGURATION (USING YOUR NEW PROJECT KEYS) ---
        // NOTE: The canvas environment provides __firebase_config, but we keep the hardcoded one for standalone testing
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyDqiw7UTiSPEDXDFRwZPBmBBWQ0sYlQLGg",
            authDomain: "exercise-progress-tracker.firebaseapp.com",
            projectId: "exercise-progress-tracker",
            storageBucket: "exercise-progress-tracker.firebasestorage.app",
            messagingSenderId: "1009491659527",
            appId: "1:1009491659527:web:2488324d4c0cf441acd3a2"
        };
        
        // Environment variables required for Canvas functionality
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : hardcodedFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Utility to safely retrieve the current user's ID
        const getCurrentUserId = () => auth.currentUser?.uid;

        // App logic object to manage state and functions
        window.appLogic = {
            // STATE
            userId: null,
            history: {}, 
            dailyGoalData: {}, 
            charts: {}, 
            activePeriod: 'week', // 'week', 'month', 'year', 'all', or 'custom'
            customGoals: [], 
            modalTargetArea: null, 
            activePeriodData: {}, 
            customGoalDefinitions: {}, 
            isGoalFormVisible: false, 
            customDateTarget: null, // Stores moment object for custom date analysis

            // CONSTANTS
            TRACKER_AREAS: ['pushups', 'crunches', 'squats', 'taekwondo', 'mindset'],
            DEFAULT_GOALS: {
                pushups: { progress: 0, goal: 50, unit: 'Reps', color: 'green' },
                crunches: { progress: 0, goal: 75, unit: 'Reps', color: 'blue' },
                squats: { progress: 0, goal: 100, unit: 'Reps', color: 'purple' },
                taekwondo: { progress: 0, goal: 15, unit: 'Min', color: 'red' }, 
                mindset: { status: 'Untoggled', is100: false, unit: 'Affirmed', color: 'yellow' },
            },
            
            // --- UTILITIES & UI HELPERS ---
            showStatusMessage(message, color) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.textContent = message;
                statusMessage.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 ${color} text-white rounded-lg shadow-xl z-50 text-sm opacity-100 transition-opacity duration-300`;
                statusMessage.classList.remove('hidden');

                setTimeout(() => {
                    statusMessage.classList.remove('opacity-100');
                    statusMessage.classList.add('opacity-0');
                    setTimeout(() => statusMessage.classList.add('hidden'), 300);
                }, 3000);
            },

            setLoading(isLoading) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !isLoading);
                document.getElementById('googleSignInBtn').disabled = isLoading;
            },

            getTodayDateKey() {
                return moment().format('YYYY-MM-DD');
            },

            // --- NEW FEATURE: Toggle Goal Form Visibility ---
            toggleCustomGoalForm() {
                appLogic.isGoalFormVisible = !appLogic.isGoalFormVisible;
                const form = document.getElementById('customGoalCreator');
                const button = document.getElementById('toggleGoalFormBtn');
                
                if (appLogic.isGoalFormVisible) {
                    form.classList.remove('hidden');
                    button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg><span>Hide Custom Goal Form</span>';
                } else {
                    form.classList.add('hidden');
                    button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg><span>Add New Custom Goal</span>';
                }
            },


            // --- AUTHENTICATION HANDLERS ---
            async handleGoogleLogin() {
                if (!auth) {
                     appLogic.showStatusMessage('Initialization Failed. Please refresh.', 'bg-red-500');
                     return;
                }

                appLogic.setLoading(true);

                const provider = new GoogleAuthProvider();
                
                provider.setCustomParameters({
                    prompt: 'select_account' 
                });

                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
                        appLogic.showStatusMessage('Pop-up blocked or cancelled. Check browser settings.', 'bg-yellow-600');
                    } else if (error.code !== 'auth/popup-closed-by-user') {
                         appLogic.showStatusMessage(`Sign In Failed: ${error.message}`, 'bg-red-500');
                    }
                    appLogic.setLoading(false);
                }
            },

            handleLogout() {
                signOut(auth);
                appLogic.showStatusMessage('Successfully logged out.', 'bg-gray-500');
            },
            
            setUserId: (uid) => {
                appLogic.userId = uid;
                document.getElementById('userIdDisplay').textContent = uid ? uid : 'No User';
                if (uid) {
                    appLogic.setupDataListener();
                }
            },

            // --- FIREBASE DATA SYNC (MODULAR) ---
            async setupDataListener() {
                if (!appLogic.userId) return;

                const historyDocRef = doc(db, 'artifacts', appId, 'users', appLogic.userId, 'growthData', 'history');
                const definitionsDocRef = doc(db, 'artifacts', appId, 'users', appLogic.userId, 'customGoals', 'definitions');

                appLogic.setLoading(true);
                
                let historyLoaded = false;
                let definitionsLoaded = false;

                const checkComplete = () => {
                    if (historyLoaded && definitionsLoaded) {
                        const todayKey = appLogic.getTodayDateKey();
                        let dailyData = appLogic.history[todayKey] || {};

                        // 1. Load custom goals from the small definitions document
                        appLogic.customGoals = Object.keys(appLogic.customGoalDefinitions);

                        // 2. Initialize today's data with fixed defaults AND custom goal definitions
                        appLogic.dailyGoalData = Object.assign({}, appLogic.DEFAULT_GOALS);
                        
                        // Merge custom definitions into appLogic.dailyGoalData for today's goals
                        appLogic.customGoals.forEach(area => {
                            const def = appLogic.customGoalDefinitions[area];
                            appLogic.dailyGoalData[area] = Object.assign({ progress: 0 }, def);
                        });

                        // 3. Overlay today's progress from history
                        appLogic.dailyGoalData = Object.assign(appLogic.dailyGoalData, dailyData);
                        appLogic.dailyGoalData.date = todayKey; 
                        
                        appLogic.renderUI();
                        appLogic.setLoading(false);
                    }
                };

                try {
                    // Listener for large History data (can be slow)
                    onSnapshot(historyDocRef, docSnapshot => {
                        const data = docSnapshot.data() || {};
                        appLogic.history = data.history || {};
                        historyLoaded = true;
                        checkComplete();
                    }, error => {
                        appLogic.showStatusMessage(`History DB Error: ${error.message}`, 'bg-red-500');
                        console.error("Firestore History Error:", error);
                        historyLoaded = true;
                        checkComplete();
                    });

                    // NEW: Listener for small Definitions data (should be fast)
                    onSnapshot(definitionsDocRef, docSnapshot => {
                        appLogic.customGoalDefinitions = docSnapshot.data() || {};
                        definitionsLoaded = true;
                        checkComplete();
                    }, error => {
                        appLogic.showStatusMessage(`Definitions DB Error: ${error.message}`, 'bg-red-500');
                        console.error("Firestore Definitions Error:", error);
                        definitionsLoaded = true;
                        checkComplete();
                    });

                } catch (e) {
                    appLogic.showStatusMessage('Failed to set up data listeners.', 'bg-red-500');
                    appLogic.setLoading(false);
                }
            },
            
            saveCustomGoalDefinitions() {
                if (!appLogic.userId) return;
                const definitionsDocRef = doc(db, 'artifacts', appId, 'users', appLogic.userId, 'customGoals', 'definitions');
                
                const definitionsToSave = {};
                
                appLogic.customGoals.forEach(area => {
                    const data = appLogic.dailyGoalData[area];
                    if (data) {
                        definitionsToSave[area] = {
                            goal: data.goal,
                            unit: data.unit,
                            // Ensure color is a fallback safe color
                            color: data.color && data.color !== 'undefined' ? data.color : 'indigo' 
                        };
                    }
                });

                try {
                    setDoc(definitionsDocRef, definitionsToSave);
                } catch (e) {
                    appLogic.showStatusMessage(`Definition save failed: ${e.message}`, 'bg-red-500');
                }
            },

            async saveHistory() {
                if (!appLogic.userId) {
                    appLogic.showStatusMessage('Authentication required to save progress.', 'bg-red-500');
                    return;
                }

                const todayKey = appLogic.getTodayDateKey();
                const historyDocRef = doc(db, 'artifacts', appId, 'users', appLogic.userId, 'growthData', 'history');

                const dataToSave = {};
                
                // Save fixed and custom goals for today
                const allCurrentGoals = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals, 'mindset');

                allCurrentGoals.forEach(area => {
                    if (appLogic.dailyGoalData[area]) {
                         // Only save data that is present in the dailyGoalData
                         dataToSave[area] = appLogic.dailyGoalData[area];
                    }
                });

                appLogic.history[todayKey] = {
                    ...dataToSave,
                    date: todayKey
                };
                
                try {
                    // Update the entire history object with the current day's update
                    await setDoc(historyDocRef, { history: appLogic.history });
                } catch (e) {
                    appLogic.showStatusMessage(`History save failed: ${e.message}`, 'bg-red-500');
                }
            },

            // --- TRACKER LOGIC ---
            updateGoal(area, inputId) { 
                const input = document.getElementById(inputId);
                let goal = parseFloat(input.value);
                
                if (isNaN(goal) || goal <= 0) {
                    const defaultGoal = appLogic.DEFAULT_GOALS[area] ? appLogic.DEFAULT_GOALS[area].goal : 30; 
                    goal = defaultGoal;
                    input.value = goal;
                    appLogic.showStatusMessage('Goal must be a positive number.', 'bg-yellow-600');
                }
                
                // Ensure data structure exists for custom goals
                if (!appLogic.dailyGoalData[area]) {
                    appLogic.dailyGoalData[area] = Object.assign({ progress: 0 }, appLogic.customGoalDefinitions[area] || { unit: 'Units', color: 'indigo' });
                }
                
                appLogic.dailyGoalData[area].goal = goal;
                
                // Save definitions only for custom goals
                if (appLogic.customGoals.includes(area)) {
                    appLogic.saveCustomGoalDefinitions();
                }

                appLogic.saveHistory();
                appLogic.showStatusMessage(`Goal for ${area.replace(/_/g, ' ')} updated to ${goal} ${appLogic.dailyGoalData[area].unit}.`, 'bg-blue-500');
            },

            updateTracker(area, inputId) { 
                const input = document.getElementById(inputId);
                const value = parseFloat(input.value);

                if (isNaN(value) || value <= 0) {
                    appLogic.showStatusMessage('Please enter a valid positive number.', 'bg-red-500');
                    return;
                }
                
                // Ensure data structure exists (crucial for custom goals being tracked first time today)
                 if (!appLogic.dailyGoalData[area]) {
                    appLogic.dailyGoalData[area] = Object.assign({ progress: 0 }, appLogic.customGoalDefinitions[area] || appLogic.DEFAULT_GOALS[area]);
                }

                appLogic.dailyGoalData[area].progress = (appLogic.dailyGoalData[area].progress || 0) + value;
                input.value = ''; 
                appLogic.saveHistory();
                appLogic.showStatusMessage(`Logged ${value} ${appLogic.dailyGoalData[area].unit} for ${area.replace(/_/g, ' ')}!`, 'bg-green-500');
            },
            
            // ... (mindset functions remain the same) ...
            toggleMindsetStatus() { 
                const area = 'mindset';
                appLogic.dailyGoalData[area].is100 = !appLogic.dailyGoalData[area].is100;
                appLogic.saveHistory();
                if (appLogic.dailyGoalData[area].is100) {
                    appLogic.showStatusMessage('Commitment: 100% affirmed!', 'bg-yellow-400');
                } else {
                    appLogic.showStatusMessage('Commitment status reset.', 'bg-gray-500');
                }
            },
            
            resetDailyProgress() { 
                appLogic.modalActions.show(
                    'Confirm Daily Reset',
                    'Are you sure you want to **reset all progress for today**? This is typically done at the start of a new day.',
                    'Confirm Reset',
                    () => {
                        const todayKey = appLogic.getTodayDateKey();
                        const currentGoals = appLogic.dailyGoalData;
                        const newDailyData = { date: todayKey };
                        
                        const allGoals = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals);

                        allGoals.forEach(area => {
                            const data = currentGoals[area] || appLogic.DEFAULT_GOALS[area] || appLogic.customGoalDefinitions[area];
                            if (data) {
                                newDailyData[area] = { 
                                    progress: 0, 
                                    goal: data.goal, 
                                    unit: data.unit, 
                                    color: data.color 
                                };
                            }
                        });

                        newDailyData['mindset'] = { status: 'Untoggled', is100: false, color: 'yellow' };

                        appLogic.dailyGoalData = newDailyData; 
                        appLogic.saveHistory();
                        appLogic.showStatusMessage('Daily progress reset! New day, new opportunities!', 'bg-blue-600');
                    }
                );
            },
            
            removeGoal(area) {
                appLogic.modalActions.show(
                    'Confirm Deletion',
                    `Are you sure you want to permanently erase the **${area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}** goal? This action is irreversible and will **delete ALL history** for this goal from the database.`,
                    'Erase History',
                    () => {
                        appLogic.modalActions.hide();
                        
                        appLogic.customGoals = appLogic.customGoals.filter(g => g !== area);
                        
                        // Delete definition
                        if (appLogic.customGoalDefinitions[area]) {
                             delete appLogic.customGoalDefinitions[area];
                             appLogic.saveCustomGoalDefinitions();
                        }
                        
                        // Delete today's data (if present)
                        if (appLogic.dailyGoalData[area]) {
                            delete appLogic.dailyGoalData[area];
                        }

                        // Delete from history (which triggers saveHistory listener)
                        Object.keys(appLogic.history).forEach(dateKey => {
                            if (appLogic.history[dateKey] && appLogic.history[dateKey][area]) {
                                delete appLogic.history[dateKey][area];
                            }
                        });

                        appLogic.saveHistory(); // Save the modified history object
                        
                        appLogic.renderUI(); 
                        appLogic.showStatusMessage(`${area.replace(/_/g, ' ')} goal successfully removed! (History erased)`, 'bg-red-600');
                    }
                );
            },
            
            modalActions: {
                currentConfirmationCallback: null,

                show(title, message, confirmText, callback) {
                    const modal = document.getElementById('confirmationModal');
                    const modalTitle = modal.querySelector('h3');
                    const modalMessage = document.getElementById('modalMessage');
                    const confirmBtn = document.getElementById('confirmDeleteBtn');
                    
                    modalTitle.textContent = title;
                    modalMessage.innerHTML = message;
                    confirmBtn.textContent = confirmText;
                    
                    if (confirmText.toLowerCase().includes('erase') || confirmText.toLowerCase().includes('delete')) {
                         confirmBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                         confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    } else {
                         confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                         confirmBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }

                    appLogic.modalActions.currentConfirmationCallback = callback;
                    
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('opacity-100');
                        modal.querySelector('.transform').classList.remove('scale-95');
                        modal.querySelector('.transform').classList.add('scale-100');
                    }, 10);
                },

                hide() {
                    const modal = document.getElementById('confirmationModal');
                    modal.classList.remove('opacity-100');
                    modal.querySelector('.transform').classList.remove('scale-100');
                    modal.querySelector('.transform').classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    appLogic.modalTargetArea = null; 
                },

                cancel() {
                    appLogic.modalActions.hide();
                    appLogic.modalActions.currentConfirmationCallback = null;
                },

                confirm() {
                    if (appLogic.modalActions.currentConfirmationCallback) {
                        appLogic.modalActions.currentConfirmationCallback();
                    }
                    appLogic.modalActions.hide();
                }
            },
            
            // --- RENDER CARD AND ADD GOAL ---
            renderCard(area, data, label) {
                // Safely determine color (Tailwind safe list for dynamic generation)
                const safeColor = data.color && ['green', 'blue', 'purple', 'red', 'indigo', 'yellow', 'pink', 'teal', 'orange'].includes(data.color) ? data.color : 'indigo';
                const removeButton = appLogic.customGoals.includes(area) ? 
                    `<button onclick="appLogic.removeGoal('${area}')" class="text-xs text-red-400 hover:text-red-600 font-medium transition duration-150 mt-2">Remove Goal</button>` : '';
                
                // Generic SVG for custom goals
                const customSvgPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>';

                const cardHtml = `
                    <div id="${area}Card" class="tracker-card bg-white p-6 border-l-4 border-${safeColor}-400">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2 text-${safeColor}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${customSvgPath}</svg>
                                ${label}
                            </span>
                             ${removeButton}
                        </h3>
                        <label for="${area}Goal" class="text-sm font-medium text-gray-500">Goal: ${data.unit}</label>
                        <input type="number" id="${area}Goal" onchange="appLogic.updateGoal('${area}', '${area}Goal')" value="${data.goal || 30}" min="1" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-${safeColor}-400 focus:border-${safeColor}-400">
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700 mb-1">Daily Progress</p>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="${area}Input" placeholder="0" min="0" step="1" class="w-2/3 p-2 border border-gray-300 rounded-lg focus:ring-${safeColor}-400 focus:border-${safeColor}-400">
                                <button onclick="appLogic.updateTracker('${area}', '${area}Input')" class="w-1/3 bg-${safeColor}-400 hover:bg-${safeColor}-500 text-white font-semibold py-2 rounded-lg transition duration-150">Log</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-gray-700 text-sm font-medium">Progress: <span id="${area}ProgressText" class="font-bold">0%</span></p>
                            <div class="w-full bg-gray-200 progress-bar mt-1">
                                <div id="${area}ProgressBar" class="progress-bar bg-${safeColor}-400" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                `;
                return cardHtml;
            },
            
            addCustomGoal() {
                const nameInput = document.getElementById('customGoalName');
                const targetInput = document.getElementById('customGoalTarget');
                const unitInput = document.getElementById('customGoalUnit');

                const name = nameInput.value.trim();
                const target = parseFloat(targetInput.value);
                const unit = unitInput.value;

                if (!name || isNaN(target) || target <= 0) {
                    appLogic.showStatusMessage('Please enter a valid name and positive goal.', 'bg-red-500');
                    return;
                }

                // Create a clean key for Firebase/CSS class naming
                const areaKey = name.toLowerCase().replace(/[^a-z0-9]/g, '_'); 
                
                if (appLogic.TRACKER_AREAS.includes(areaKey) || appLogic.customGoals.includes(areaKey)) {
                    appLogic.showStatusMessage(`Goal '${name}' already exists.`, 'bg-yellow-600');
                    return;
                }
                
                // Simple color rotation for new goals (tailwind safe list)
                const colors = ['indigo', 'pink', 'teal', 'orange'];
                const color = colors[appLogic.customGoals.length % colors.length];

                const newGoalDefinition = {
                    goal: target,
                    unit: unit,
                    color: color
                };
                
                appLogic.customGoalDefinitions[areaKey] = newGoalDefinition;
                appLogic.dailyGoalData[areaKey] = Object.assign({ progress: 0 }, newGoalDefinition);
                appLogic.customGoals.push(areaKey);

                nameInput.value = '';
                targetInput.value = 30;
                unitInput.value = 'Reps';
                
                appLogic.saveCustomGoalDefinitions();
                appLogic.saveHistory();
                appLogic.toggleCustomGoalForm(); 

                appLogic.showStatusMessage(`Custom Goal '${name}' added!`, 'bg-indigo-600');
            },


            // --- RENDER UI ---
            renderUI() { 
                document.getElementById('todayDateDisplay').textContent = moment().format('ddd, MMM D, YYYY');
                
                const customGoalsGrid = document.getElementById('customGoalsGrid');
                customGoalsGrid.innerHTML = ''; 

                const allTrackedAreas = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals);

                allTrackedAreas.forEach(area => {
                    const data = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area] || appLogic.customGoalDefinitions[area];
                    if (!data) return; // Skip if no definition found
                    
                    const goal = data.goal || 1; // Prevent division by zero
                    const progress = data.progress || 0;
                    
                    if (appLogic.customGoals.includes(area)) {
                        const areaLabel = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        customGoalsGrid.insertAdjacentHTML('beforeend', appLogic.renderCard(area, data, areaLabel));
                        
                    } else {
                         // Update fixed cards
                        const goalInput = document.getElementById(`${area}Goal`);
                        if(goalInput) goalInput.value = goal;
                    }

                    const progressPercent = Math.min(100, (progress / goal) * 100);
                    const progressBar = document.getElementById(`${area}ProgressBar`);
                    const progressText = document.getElementById(`${area}ProgressText`);
                    const card = document.getElementById(`${area}Card`);
                    const colorCode = data.color || 'indigo';

                    if (progressBar && progressText && card) { 
                        progressBar.style.width = `${progressPercent}%`;
                        progressText.textContent = `${progress} / ${goal} ${data.unit} (${Math.round(progressPercent)}%)`;

                        // Remove all possible ring/bg classes before applying new one to prevent class bloat
                        const ringClasses = ['ring-green-400', 'ring-blue-400', 'ring-purple-400', 'ring-red-400', 'ring-indigo-400', 'ring-pink-400', 'ring-teal-400', 'ring-orange-400', 'ring-offset-white'];
                        card.classList.remove('ring-2', 'ring-offset-2', ...ringClasses);

                        const bgClasses = ['!bg-green-600', '!bg-blue-600', '!bg-purple-600', '!bg-red-600', '!bg-indigo-600', '!bg-pink-600', '!bg-teal-600', '!bg-orange-600'];
                        progressBar.classList.remove(...bgClasses);


                        if (progressPercent >= 100) {
                            // Safely add ring classes
                            card.classList.add('ring-2', 'ring-offset-2', `ring-${colorCode}-400`, 'ring-offset-white');
                            progressBar.classList.add(`!bg-${colorCode}-600`);
                        }
                    }
                });

                // Render Mindset Card
                const mindsetBtn = document.getElementById('mindsetStatusBtn');
                const mindsetFeedback = document.getElementById('mindsetFeedback');
                const mindsetData = appLogic.dailyGoalData['mindset'] || appLogic.DEFAULT_GOALS['mindset'];
                const is100 = mindsetData.is100;

                if (is100) {
                    mindsetBtn.textContent = 'COMMITMENT Locked';
                    mindsetBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    mindsetBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    mindsetFeedback.innerHTML = '<span class="status-badge bg-green-100 text-green-700">Commitment is Locked In!</span>';
                    document.getElementById('believeCard').classList.remove('border-yellow-400');
                    document.getElementById('believeCard').classList.add('border-green-400');

                } else {
                    mindsetBtn.textContent = 'Affirm Commitment';
                    mindsetBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    mindsetBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                    mindsetFeedback.innerHTML = '<span class="status-badge bg-yellow-100 text-yellow-700">Awaiting Affirmation</span>';
                    document.getElementById('believeCard').classList.remove('border-green-400');
                    document.getElementById('believeCard').classList.add('border-yellow-400');
                }
                
                // Initialize month picker with current month's value
                const todayMoment = moment();
                document.getElementById('monthYearPicker').value = todayMoment.format('YYYY-MM');

                appLogic.setAnalysisPeriod(appLogic.activePeriod);
            },
            
            // --- ANALYSIS & CHARTING ---

            // NEW FUNCTION to handle the View Report button click
            viewHistoricalReport() {
                const picker = document.getElementById('monthYearPicker');
                const monthYear = picker.value;

                if (!monthYear) {
                    appLogic.showStatusMessage('Please select a month and year.', 'bg-red-500');
                    return;
                }
                
                // Parse the YYYY-MM string into a moment object
                const targetDate = moment(monthYear, 'YYYY-MM');
                
                // Set the custom analysis target and trigger rendering
                appLogic.customDateTarget = targetDate;
                appLogic.setAnalysisPeriod('custom');
            },

            // Updated setAnalysisPeriod to handle custom date target
            setAnalysisPeriod(period) {
                appLogic.activePeriod = period;
                
                // Remove active styling from all default period buttons
                document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('period-active'));

                // Apply active styling only if it's a non-custom period button
                if (period !== 'custom') {
                    const activeBtn = document.getElementById(`${period}Btn`);
                    if (activeBtn) { activeBtn.classList.add('period-active'); }
                    appLogic.customDateTarget = null; // Clear custom target for default modes
                } else {
                     // For custom mode, we use the date picker's month value to highlight its use
                }

                appLogic.renderAnalysis();
            },

            // Updated getAnalysisDuration to calculate date ranges for custom month report
            getAnalysisDuration() { 
                const today = moment().startOf('day');
                let duration, previousDuration;
                let currentPeriodStart, currentPeriodEnd, previousPeriodStart, previousPeriodEnd;
                let currentLabel, previousLabel;

                if (appLogic.activePeriod === 'custom' && appLogic.customDateTarget) {
                    // Custom Month Report Logic
                    const targetMonth = appLogic.customDateTarget.clone();
                    
                    currentPeriodStart = targetMonth.startOf('month').startOf('day');
                    currentPeriodEnd = targetMonth.endOf('month').startOf('day');
                    
                    const prevMonth = targetMonth.clone().subtract(1, 'month');
                    previousPeriodStart = prevMonth.startOf('month').startOf('day');
                    previousPeriodEnd = prevMonth.endOf('month').startOf('day');

                    // Calculate number of days in the month
                    duration = currentPeriodEnd.diff(currentPeriodStart, 'days') + 1;
                    previousDuration = previousPeriodEnd.diff(previousPeriodStart, 'days') + 1;
                    
                    currentLabel = currentPeriodStart.format('MMMM YYYY');
                    previousLabel = previousPeriodStart.format('MMMM YYYY');

                } else {
                    // Default Period Logic ('week', 'month', 'year', 'all')
                    const end = today;

                    switch (appLogic.activePeriod) {
                        case 'week': 
                            duration = 7; previousDuration = 7;
                            currentLabel = 'Current Week'; 
                            previousLabel = 'Previous Week';
                            break;
                        case 'month': 
                            duration = 30; previousDuration = 30; 
                            currentLabel = 'Last 30 Days';
                            previousLabel = 'Previous 30 Days';
                            break;
                        case 'year': 
                            duration = 365; previousDuration = 365; 
                            currentLabel = 'Last Year';
                            previousLabel = 'Year Before';
                            break;
                        case 'all':
                            const historyDates = Object.keys(appLogic.history).sort();
                            if (historyDates.length === 0) { 
                                duration = 1; previousDuration = 0; 
                            } else {
                                const firstDay = moment(historyDates[0], 'YYYY-MM-DD').startOf('day');
                                const totalDays = today.diff(firstDay, 'days') + 1;
                                duration = Math.ceil(totalDays / 2); previousDuration = Math.floor(totalDays / 2); 
                            }
                            currentLabel = 'Second Half (All Time)';
                            previousLabel = 'First Half (All Time)';
                            break;
                        default: 
                            duration = 7; previousDuration = 7;
                            currentLabel = 'Current Week'; 
                            previousLabel = 'Previous Week';
                    }

                    currentPeriodStart = moment(end).subtract(duration - 1, 'days').startOf('day');
                    currentPeriodEnd = end;
                    previousPeriodEnd = moment(currentPeriodStart).subtract(1, 'second').startOf('day');
                    previousPeriodStart = moment(previousPeriodEnd).subtract(previousDuration - 1, 'days').startOf('day');

                }
                
                return { 
                    duration, 
                    previousDuration, 
                    currentPeriodStart, 
                    currentPeriodEnd, 
                    previousPeriodStart, 
                    previousPeriodEnd,
                    currentLabel,
                    previousLabel
                };
            },
            
            getDailyPerformance(duration, endDate, startDate) { 
                const dailyData = {};
                const areaKeys = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 
                const end = endDate;
                const start = startDate;
                
                const datesInPeriod = [];
                for (let date = moment(start); date.isSameOrBefore(end); date.add(1, 'days')) {
                    datesInPeriod.push(date.format('YYYY-MM-DD'));
                }

                datesInPeriod.forEach(dateKey => {
                    const data = appLogic.history[dateKey];
                    const result = {};
                    areaKeys.forEach(area => {
                        const definition = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area] || appLogic.customGoalDefinitions[area];
                        if (!definition) return;
                        
                        // Use the historical data if available, otherwise assume 0 progress
                        const areaData = data && data[area] ? data[area] : { progress: 0, goal: definition.goal, unit: definition.unit };
                        
                        const progress = areaData.progress || 0;
                        const goal = areaData.goal || definition.goal; 
                        
                        const completion = goal > 0 ? Math.min(100, (progress / goal) * 100) : 0;
                        
                        result[area] = completion; 
                    });
                    dailyData[dateKey] = result;
                });
                return dailyData;
            },
            
            calculateAverages(periodData) { 
                const areaKeys = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 
                const total = areaKeys.reduce((acc, area) => ({ ...acc, [area]: 0 }), {});
                const days = Object.keys(periodData).length;
                let validAreaCount = 0;
                
                Object.values(periodData).forEach(day => {
                    areaKeys.forEach(area => {
                         const completionValue = day[area] === null || day[area] === undefined ? 0 : day[area];
                         total[area] += completionValue;
                    });
                });
                
                const avg = {};
                areaKeys.forEach(area => {
                    const definition = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area] || appLogic.customGoalDefinitions[area];
                    if (definition) {
                        avg[area] = days > 0 ? (total[area] / days) : 0;
                        validAreaCount++;
                    }
                });
                
                const overallAvg = validAreaCount > 0 ? (Object.values(avg).reduce((sum, val) => sum + val, 0) / validAreaCount) : 0;
                
                return { avg: avg, overallAvg: overallAvg, days: days };
            },
            
            renderAnalysis() { 
                const { 
                    duration, 
                    currentPeriodStart, 
                    currentPeriodEnd, 
                    previousPeriodStart, 
                    previousPeriodEnd,
                    currentLabel,
                    previousLabel
                } = appLogic.getAnalysisDuration();
                
                const currentDataRaw = appLogic.getDailyPerformance(duration, currentPeriodEnd, currentPeriodStart);
                const previousDataRaw = appLogic.getDailyPerformance(duration, previousPeriodEnd, previousPeriodStart); // Use duration days for previous

                const currentAverages = appLogic.calculateAverages(currentDataRaw);
                const previousAverages = appLogic.calculateAverages(previousDataRaw);
                
                appLogic.activePeriodData = { currentDataRaw, previousDataRaw };

                const currentAvgScore = Math.round(currentAverages.overallAvg);
                const previousAvgScore = Math.round(previousAverages.overallAvg);
                const diff = currentAvgScore - previousAvgScore;

                document.getElementById('currentPeriodLabel').textContent = `${currentLabel} (${currentAverages.days} Days)`;
                document.getElementById('previousPeriodLabel').textContent = `${previousLabel} (${previousAverages.days} Days)`;
                document.getElementById('currentAvgScore').textContent = `${currentAvgScore}%`;
                document.getElementById('previousAvgScore').textContent = `${previousAvgScore}%`;
                
                const diffElement = document.getElementById('scoreDifference');
                diffElement.innerHTML = `${diff > 0 ? '' : diff < 0 ? '' : ''} ${Math.abs(diff)}%`;
                diffElement.classList.toggle('text-green-600', diff >= 0);
                diffElement.classList.toggle('text-red-600', diff < 0);
                
                // Labels for the X-axis of the chart (based on current period dates)
                const labels = Array.from({ length: currentAverages.days }, (_, i) => {
                     return moment(currentPeriodStart).add(i, 'days').format('MM/DD');
                });
                
                const allChartAreas = appLogic.TRACKER_AREAS.filter(a => a !== 'mindset').concat(appLogic.customGoals); 

                const analysisContainer = document.getElementById('chartGrid');
                analysisContainer.innerHTML = ''; 

                allChartAreas.forEach(area => {
                    const data = appLogic.dailyGoalData[area] || appLogic.DEFAULT_GOALS[area] || appLogic.customGoalDefinitions[area];
                    if (!data) return; // Skip if no definition

                    const currentTrend = labels.map((label, i) => {
                         const dateKey = moment(currentPeriodStart).add(i, 'days').format('YYYY-MM-DD');
                         return currentDataRaw[dateKey] ? currentDataRaw[dateKey][area] : 0; 
                    });
                    
                    // Generate previous trend data, ensuring it has the same length as current trend for comparison
                    const previousKeys = Object.keys(previousDataRaw).sort();
                    const previousTrend = currentTrend.map((_, i) => {
                        const prevDateKey = moment(previousPeriodStart).add(i, 'days').format('YYYY-MM-DD');
                        return previousDataRaw[prevDateKey] && previousDataRaw[prevDateKey][area] !== undefined ? previousDataRaw[prevDateKey][area] : 0;
                    });
                    
                    const chartCard = document.createElement('div');
                    // Add fixed width for mobile scrolling
                    chartCard.classList.add('analysis-card', 'h-64', 'md:h-72', 'w-full', 'lg:w-auto', 'lg:col-span-1'); 
                    chartCard.innerHTML = `<canvas id="${area}Chart"></canvas>`; 
                    analysisContainer.appendChild(chartCard); 
                    
                    appLogic.drawChart(area, labels, currentTrend, previousTrend, data.color);
                });
            },

            drawChart(area, labels, currentTrend, previousTrend, colorCode) { 
                if (appLogic.charts[area]) { appLogic.charts[area].destroy(); }
                const ctx = document.getElementById(`${area}Chart`);
                if (!ctx) return;
                const context = ctx.getContext('2d');

                let color, label;
                const areaName = area.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); 

                // Simple color map based on Tailwind defaults for the graph lines
                const colorMap = {
                    green: 'rgba(52, 211, 153, 1)',
                    blue: 'rgba(96, 165, 250, 1)',
                    purple: 'rgba(167, 139, 250, 1)',
                    red: 'rgba(248, 113, 113, 1)',
                    pink: 'rgba(236, 72, 153, 1)',
                    teal: 'rgba(20, 184, 166, 1)',
                    orange: 'rgba(251, 146, 60, 1)',
                    indigo: 'rgba(79, 70, 229, 1)',
                    yellow: 'rgba(251, 191, 36, 1)'
                };

                color = colorMap[colorCode] || colorMap['indigo'];
                label = `${areaName} Progress`;


                appLogic.charts[area] = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { 
                                label: 'Current Period', 
                                data: currentTrend, 
                                borderColor: color, 
                                backgroundColor: color.replace('1)', '0.1)'), 
                                fill: true, 
                                tension: 0.4, 
                                pointRadius: 3, 
                                borderWidth: 3,
                                spanGaps: false 
                            },
                            { 
                                label: 'Previous Period', 
                                data: previousTrend, 
                                borderColor: color.replace('1)', '0.5)'), 
                                backgroundColor: 'transparent', 
                                borderDash: [5, 5], 
                                fill: false, 
                                tension: 0.4, 
                                pointRadius: 0, 
                                borderWidth: 2,
                                spanGaps: false
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: label, color: '#4B5563', padding: { top: 10, bottom: 5 } }
                        },
                        scales: {
                            x: { 
                                grid: { display: false }, 
                                ticks: { 
                                    autoSkip: true, 
                                    maxRotation: 0, 
                                    minRotation: 0,
                                }
                            },
                            y: { 
                                min: 0, 
                                max: 100, 
                                title: { display: true, text: 'Completion (%)' },
                                suggestedMin: 0
                            }
                        }
                    }
                });
            }
        };


        // --- INITIALIZATION ---
        window.onload = async function() {
            setLogLevel('debug');
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("FATAL: Firebase Initialization Error:", e);
                appLogic.showStatusMessage('FATAL: Initialization failed.', 'bg-red-900');
                return;
            }

            let authStateHandled = false;
            appLogic.setLoading(true);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Initial Auth Error:", e);
            }
            
            const loadingTimeout = setTimeout(() => {
                if (!authStateHandled) {
                    appLogic.setLoading(false);
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('googleSignInBtn').disabled = false;
                    appLogic.showStatusMessage('Automatic sign-in failed. Please sign in with Google.', 'bg-yellow-600');
                }
            }, 5000);

            onAuthStateChanged(auth, (user) => {
                clearTimeout(loadingTimeout);
                authStateHandled = true;

                appLogic.setLoading(false); 
                document.getElementById('googleSignInBtn').disabled = false; 

                if (user) {
                    appLogic.setUserId(user.uid);
                    document.getElementById('authContainer').classList.add('hidden');
                    document.getElementById('trackerAppContainer').classList.remove('hidden');
                    appLogic.showStatusMessage('Successfully loaded dashboard.', 'bg-indigo-600');
                } else {
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('trackerAppContainer').classList.add('hidden');
                }
            });
        };
    </script>

</body>
</html>

